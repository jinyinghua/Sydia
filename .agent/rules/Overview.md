---
trigger: always_on
---

### **Sydia 项目架构全景图**

#### **1. 记忆模块**
*   **存储层**：
    *   **Chat DB**：存储单一流式的长对话记录（SQLite)。
    *   **Vector DB**：存储对话摘要的 Embedding 向量，用于语义检索。
*   **处理层 (异步云端)**：
    *   **Async Worker**：对话结束或达到阈值（如每3轮）触发 `WorkManager`。
    *   **Cloud API**：调用云端模型进行 **Embedding** 和 **关键词提取**。
    *   **逻辑控制**：计算记忆权重并应用遗忘曲线逻辑，决定哪些记忆进入长期库。

#### **2. 设置模块**
*   **功能管理**：
    *   **记忆提取配置**：设置提取频率、权重算法参数。
    *   **Chat 配置**：选择 LLM 模型（云端）、上下文轮数、性格预设（犀利/防御性）。
    *   **Skills 商店**：管理本地 Skills和查看云端插件（使用需下载）。
*   **数据可视化**：查看、编辑或手动删除已生成的记忆节点。

#### **3. Chat 模块**
*   **UI 表现**：
    *   **单一长流**：放弃话题分类，所有对话按时间轴排列，支持向上无限滚动。
    *   **动态加载**：初次唤起仅加载末尾记录，随滑动按需分页加载（Paging 3）。
    *   **上下文控制**：
        *   **Reset 按钮**：在对话流中插入“逻辑断层”标记，点击后 LLM 只看标记后的新内容。
        *   **智能截断**：仅发送最近 $N$ 轮对话给 LLM，保持回复速度和成本控制。
    *   **时间轴滑动条**：右侧隐藏式滑动条，触摸时显示：
        *   **时间戳**（如：2026-02-14）。
        *   **记忆预览**（显示该段对话产生的核心记忆点）。
*   **感知开关**：
    *   **识屏切换**：用户手动勾选“允许读取屏幕”。开启后，通过 `AssistantService` 抓取当前 App 文本并注入 Prompt。

#### **4. 行动模块**
*   **Skills 插件系统**：
    *   **定义**：采用 JSON 描述文件，包含名称、描述、所需参数及触发方式。
    *   **执行手段**：
        *   **Shizuku**：执行系统级静默操作（如：修改系统设置、管理权限）。
        *   **Intent**：跨应用跳转或数据传递。
*   **闭环逻辑**：LLM 判断需求 -> 匹配 Skill -> 提取参数 -> 行动模块执行 -> 反馈结果给 Chat 界面。

---

### **核心业务流程**

1.  **感知**：
    *   用户唤起 Sydia（长按 Home 键）。
    *   Sydia 读取对话历史（最近 N 轮）+ **(可选)** 当前屏幕内容。
2.  **判断**：
    *   LLM 结合用户性格设定及检索到的相关记忆进行思考。
3.  **决策**：
    *   LLM 决定是直接回复文字，还是调用某个 **Skill**（如：发个表情包、查个资料）。
4.  **行动**：
    *   行动模块通过 Shizuku/Intent 落地执行。
    *   **异步环节**：对话结束后，Worker 悄悄在后台把新信息变成“记忆”存入数据库。

---

### **技术难点备忘 (Priority)**

1.  **UI 性能**：右侧自定义时间轴滑动条与 `RecyclerView` 的联动，以及滑动时记忆节点的实时预览。
2.  **逻辑断层处理**：如何在数据库中优雅地标记“上下文清空”，并确保 LLM 推理时能准确识别这个边界。
3.  **云端异步同步**：确保网络波动时，后台的 Embedding 任务不会丢失，且能正确关联到对应的对话 ID。